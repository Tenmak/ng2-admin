<html>
<head>
  <meta charset=utf-8 />
  <title>Custom Popup with Dynamic Map Layer</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet-src.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.0.6"></script>
  
  <!-- Include the loading control -->
  <link rel="stylesheet" href="https://rawgithub.com/ebrelsford/Leaflet.loading/master/src/Control.Loading.css" />
  <script src="https://rawgithub.com/ebrelsford/Leaflet.loading/master/src/Control.Loading.js"></script>
  
    <!-- Include the zoom display -->
  <link rel="stylesheet" href="css/leaflet.zoomdisplay.css" />
  <script type="text/javascript" src="js/leaflet.zoomdisplay.js"></script>
  
  
  <!-- Include Leaflet.markercluster via rawgit.com
in production you'd be better off hosting these libraries yourself -->
  <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/Leaflet/Leaflet.markercluster/v1.0.0-rc.1/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/Leaflet/Leaflet.markercluster/v1.0.0-rc.1/dist/MarkerCluster.css">
  <script src="https://cdn.rawgit.com/Leaflet/Leaflet.markercluster/v1.0.0-rc.1/dist/leaflet.markercluster.js"></script>


  <!-- Load Clustered Feature Layer from CDN -->
  <script src="https://unpkg.com/esri-leaflet-cluster@2.0.0"></script>
  
  <!-- Load Esri Leaflet Renderers -->
  <!--script src="//cdn-geoweb.s3.amazonaws.com/esri-leaflet-renderers/0.0.1-beta.3/esri-leaflet-renderers.js"></script>
  <script src="https://w8r.github.io/esri-leaflet-legend/dist/esri-leaflet-legend-compat-src.js"></script>
  <link rel="stylesheet" type="text/css" href="https://w8r.github.io/esri-leaflet-legend/example/css/style.css" /-->
  
  <script src="js/esri-leaflet-renderers.js"></script>
  <script src="js/esri-leaflet-legend-compat-src.js"></script>
  <link rel="stylesheet" type="text/css" href="css/style.css" />

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
  </style>
</head>
<body>

<div id="map"></div>

<script>

  var map = L.map('map', {
    loadingControl: true
  }).setView([48.858435, 2.341483], 12);

  var gray = L.esri.basemapLayer('Gray', {
    minZoom: 0,
    //maxZoom: 18
  }).addTo(map);
  
  var gray = L.esri.basemapLayer('Gray');
  var dgray = L.esri.basemapLayer('DarkGray');
  var img = L.esri.basemapLayer('Imagery');
  var relief = L.esri.basemapLayer('ShadedRelief');
  var terrain = L.esri.basemapLayer('Terrain');
  var oceans = L.esri.basemapLayer('Oceans');
  var topo = L.esri.basemapLayer('Topographic');
  var streets = L.esri.basemapLayer('Streets');
  var ng = L.esri.basemapLayer('NationalGeographic');
  
  /* tile => NOK
  L.esri.tiledMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/IDF_L2E_ECW_RGF93/MapServer',
    maxZoom: 15
  }).addTo(map);
*/
  // minZoom/maxZoom => NOK ???
  var ortho = L.esri.dynamicMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/IDF_L2E_ECW_RGF93/MapServer',
    format:  'jpg',
    opacity: 1,
    transparent: false,
    position: 'back'
    //minZoom: 1,
    //maxZoom: 12
  }) //.addTo(map);


  var topo = L.esri.dynamicMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/toponymes/MapServer',
    transparent: true,
    opacity: 0.3,
    format:  'jpg'
  }) //.addTo(map);

  var vianavigo = L.esri.dynamicMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/ViaNavigo/MapServer',
    transparent: true,
    opacity: 0.7,
    format:  'jpg',
    position: 'front'
  }).addTo(map);
  
  //L.esri.Controls.legend(vianavigo).addTo(map);
 
  var ommap = L.esri.dynamicMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_MAP/MapServer',
    transparent: true,
    opacity: 0.7,
    format:  'jpg'
  }) //.addTo(map);


  var maxZoom = 15;
  var omfa = L.esri.dynamicMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/MapServer',
    opacity: 0.4,
    format:  'jpg',
    minZoom: 0,
    maxZoom: maxZoom,
    position: 'front'
    //layers: [ 0, 2, 4, 7, 8, 9, 10, 11, 12 ]
  }).addTo(map);
  
  var popupTemplate = "<h3>{OBJECTID}</h3>ID_VERSION_GEOM:{ID_VERSION_GEOM}<br><small>STATUT_GEOM: {STATUT_GEOM}<small>";

  omfa.bindPopup(function (error, featureCollection) {
    if(error || featureCollection.features.length === 0) {
      return false;
    } else {
      return L.Util.template(popupTemplate, featureCollection.features[0].properties)
    }
  });

  var perso = L.esri.dynamicMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_CARTE_PERSO/MapServer',
    opacity: 0.7,
    format:  'jpg'
  }) //.addTo(map);

  // PL_ZDL_P(13)
/*  var layer = L.esri.dynamicMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/MapServer',
    opacity: 0.5,
    format:  'jpg',
    minZoom: 0,
    //maxZoom: 18,
    layers: [ 13 ]
  }).addTo(map);

  var popupTemplate = "<h3>{OBJECTID}</h3>ID_VERSION_GEOM:{ID_VERSION_GEOM}<br><small>STATUT_GEOM: {STATUT_GEOM}<small>";

  layer.bindPopup(function (error, featureCollection) {
    if(error || featureCollection.features.length === 0) {
      return false;
    } else {
      return L.Util.template(popupTemplate, featureCollection.features[0].properties)
    }
  });
*/  
  // PL_ZDL_R(15)
/*  var layer = L.esri.dynamicMapLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/MapServer',
    opacity: 0.5,
    format:  'jpg',
    minZoom: 0,
    //maxZoom: 18,
    layers: [ 15 ]
  }).addTo(map);

  var popupTemplate = "<h3>{OBJECTID}</h3>ID_VERSION_GEOM:{ID_VERSION_GEOM}<br><small>STATUT_GEOM: {STATUT_GEOM}<small>";

  layer.bindPopup(function (error, featureCollection) {
    if(error || featureCollection.features.length === 0) {
      return false;
    } else {
      return L.Util.template(popupTemplate, featureCollection.features[0].properties)
    }
  });
*/

  var popupTemplate = "<h3>{OBJECTID}</h3>ID_VERSION_GEOM:{ID_VERSION_GEOM}<br><small>STATUT_GEOM: {STATUT_GEOM}<small>";

  // PT_ADL_R (0)
  var ptadlr = L.esri.Cluster.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/0',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  ptadlr.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  }); 
  
  // PT_ZDE_R (2)
  var ptzder = L.esri.Cluster.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/2',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  ptzder.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  }); 
  
  // PT_ZDE_P (4)
  var ptzdep = L.esri.Cluster.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/4',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  ptzdep.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  }); 

  // PT_LDA (7)
  var ptlda = L.esri.Cluster.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/7',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  ptlda.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  }); 
  
  // PT_ZDL_R (8)
  var ptzdlr = L.esri.Cluster.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/8',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  ptzdlr.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  });
  
  // LN_RELATIONHIERARCHIQUE_R (9)
  var lnrelhr = L.esri.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/9',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  lnrelhr.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  });
  
  // LN_RELATIONRP (11)
  var lnrrp = L.esri.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/11',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  lnrrp.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  });
  
  // PL_ZDL_P (13)
  var plzdlp = L.esri.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/13',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  plzdlp.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  });

  // PL_ZDL_R (15)
  var plzdlr = L.esri.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/15',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  plzdlr.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  });

  // PL_LDA (17)
  var pllda = L.esri.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/17',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  pllda.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  });
  
  // PL_GDL (19)
  var plgdl = L.esri.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/19',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  plgdl.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  });
  
  // PL_ZDE (21)
  var plzde = L.esri.featureLayer({
    url: 'https://reflex-crt.akka.eu:6443/arcgis/rest/services/REFLEX_OM_FA/FeatureServer/21',
    //minZoom: 17,
    //maxZoom: 18
  }) //.addTo(map);
  
  plzde.bindPopup(function(e){
     return L.Util.template(popupTemplate, e.feature.properties)
  });
  
  var addlayer = function(layer, maxZoom){
    map.on('zoomend', function() {
      if (map.getZoom() < maxZoom){
          if (map.hasLayer(layer)) {
              map.removeLayer(layer);
          } else {
              console.log("no layer active");
          }
      }
      if (map.getZoom() >= maxZoom){
          if (map.hasLayer(layer)){
              console.log("layer already added");
          } else {
              map.addLayer(layer);
          }
      }
    });
  }
  
  addlayer(ptadlr, maxZoom-1);
  addlayer(ptzder, maxZoom-1);
  addlayer(ptzdep, maxZoom-1);
  addlayer(ptlda, maxZoom-1);
  addlayer(ptzdlr, maxZoom-1);
  addlayer(lnrelhr, maxZoom-1);
  addlayer(lnrrp, maxZoom-1);
  addlayer(plzdlp, maxZoom-1);
  addlayer(plzdlr, maxZoom-1);
  addlayer(pllda, maxZoom-1);
  addlayer(plgdl, maxZoom-1);
  addlayer(plzde, maxZoom-1);
  
  addlayer(ortho, maxZoom);
  
  var baseLayers = {
    "Gray": gray,
    "Dark Gray": dgray,
    "Imagery": img,
    "Shaded relief": relief,
    "Terrain": terrain,
    "Oceans": oceans,
    "Topographic": topo,
    "Streets": streets,
    "National geographics": ng
   };
 
  var overlays = {
    "IDF_L2E_ECW_RGF93": ortho,
    "REFLEX_CARTE_PERSO": perso,
    "REFLEX_OM_FA": omfa,
    "REFLEX_OM_MAP": ommap,
    "TOPONYMES": topo,
    "VIANAVIGO": vianavigo
  };
  
  L.control.layers(baseLayers, overlays).addTo(map);

  
</script>

</body>
</html>
